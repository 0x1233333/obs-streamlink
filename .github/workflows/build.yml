name: Build OBS Plugin

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Dependencies
        run: |
          brew update
          brew install ffmpeg cmake simde

      # 1. 下载源码并验证文件存在
      - name: Download OBS Headers
        run: |
          rm -rf obs-studio
          git clone --depth 1 https://github.com/obsproject/obs-studio.git
          echo "=== Debug: Checking file existence ==="
          ls -l obs-studio/libobs/util/circlebuf.h || echo "FILE MISSING!"
          echo "=== End Debug ==="

      - name: Create Dummy Config
        run: |
          echo "#define OBS_VERSION \"30.0.0\"" > obs-studio/libobs/obsconfig.h

      # 2. 传递绝对路径给 CMake
      - name: Configure CMake
        run: |
          # 获取绝对路径
          OBS_PATH="${{ github.workspace }}/obs-studio/libobs"
          
          cmake -B build -S . \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_OSX_ARCHITECTURES="x86_64;arm64" \
            -DLIBOBS_PATH="$OBS_PATH" \
            -DCMAKE_INSTALL_PREFIX=./install
            
      - name: Build
        run: cmake --build build --config Release --parallel
        
      - name: Package
        run: |
          mkdir release
          find build -name "*.so" -exec cp {} release/ \;
          
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: obs-streamlink-macos
          path: release/
