name: Build OBS Plugin

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      
      # 1. 安装基础构建工具 (FFmpeg 和 CMake)
      - name: Install Dependencies
        run: |
          brew update
          brew install ffmpeg cmake

      # 2. 克隆 OBS Studio 源码 (为了获取 .h 头文件)
      # 我们只克隆最新版，深度为1，速度快
      - name: Download OBS Headers
        run: |
          git clone --depth 1 https://github.com/obsproject/obs-studio.git
          
      # 3. 配置 CMake
      # 关键参数: -DLIBOBS_INCLUDE_DIR 指向刚才下载的源码
      - name: Configure CMake
        run: |
          cmake -B build -S . \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_OSX_ARCHITECTURES="x86_64;arm64" \
            -DLIBOBS_INCLUDE_DIR="${{ github.workspace }}/obs-studio/libobs" \
            -DCMAKE_INSTALL_PREFIX=./install
            
      # 4. 编译插件
      - name: Build
        run: cmake --build build --config Release --parallel
        
      # 5. 打包产物
      - name: Package
        run: |
          mkdir release
          # 查找生成的 .so 文件并复制
          find build -name "*.so" -exec cp {} release/ \;
          
      # 6. 上传结果
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: obs-streamlink-macos
          path: release/
